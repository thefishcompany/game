<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Midnight Phantasm - Exploration</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: sans-serif; }
        canvas { display: block; cursor: crosshair; }
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <h2>탐험 모드</h2>
        <p>이동: W A S D | 손전등 조준: 마우스</p>
    </div>
    
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // 화면 크기에 맞게 캔버스 설정
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // 플레이어 설정
        const player = { x: canvas.width / 2, y: canvas.height / 2, radius: 15, speed: 4 };
        const keys = {};
        const mouse = { x: canvas.width / 2, y: canvas.height / 2 - 100 };

        // 입력 감지
        window.addEventListener("keydown", (e) => keys[e.code] = true);
        window.addEventListener("keyup", (e) => keys[e.code] = false);
        window.addEventListener("mousemove", (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        // 맵의 임시 장애물 (나중에 진짜 맵 디자인으로 교체)
        const obstacles = [
            { x: 200, y: 200, w: 100, h: 100 },
            { x: 600, y: 300, w: 50, h: 200 },
            { x: 400, y: 600, w: 300, h: 50 }
        ];

        function update() {
            // 이동 로직
            if (keys["KeyW"]) player.y -= player.speed;
            if (keys["KeyS"]) player.y += player.speed;
            if (keys["KeyA"]) player.x -= player.speed;
            if (keys["KeyD"]) player.x += player.speed;
        }

        function draw() {
            // 1. 기본 배경 (어두운 바닥)
            ctx.fillStyle = "#1a1a1a";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. 바닥 패턴 (그리드)
            ctx.strokeStyle = "#222";
            for(let i = 0; i < canvas.width; i += 50) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
            for(let i = 0; i < canvas.height; i += 50) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke(); }

            // 3. 장애물 그리기
            ctx.fillStyle = "#444";
            obstacles.forEach(obs => {
                ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                ctx.strokeStyle = "#000";
                ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
            });

            // 4. 플레이어 그리기
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();

            // 5. 어둠 및 손전등 효과 (Global Composite Operation 사용)
            // 전체를 까맣게 덮을 캔버스 상태 저장
            ctx.save();
            ctx.globalCompositeOperation = 'source-over';
            
            // 어둠의 정도 (0.95 = 거의 안보임)
            ctx.fillStyle = "rgba(0, 0, 0, 0.95)"; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 손전등 구멍 뚫기 (마우스 방향으로 부채꼴 모양 조명)
            ctx.globalCompositeOperation = 'destination-out';
            
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            const beamLength = 400; // 손전등이 닿는 거리
            const beamWidth = 0.6;  // 손전등이 퍼지는 각도

            // 부채꼴 그라데이션
            const gradient = ctx.createRadialGradient(player.x, player.y, 0, player.x, player.y, beamLength);
            gradient.addColorStop(0, "rgba(255, 255, 255, 1)"); // 시작점은 밝음
            gradient.addColorStop(1, "rgba(255, 255, 255, 0)"); // 끝점은 흐려짐

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(player.x, player.y);
            ctx.arc(player.x, player.y, beamLength, angle - beamWidth, angle + beamWidth);
            ctx.lineTo(player.x, player.y);
            ctx.fill();
            
            // 플레이어 주변 희미한 불빛 (내 발밑은 보이게)
            ctx.beginPath();
            ctx.arc(player.x, player.y, 60, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.fill();

            ctx.restore();

            requestAnimationFrame(() => {
                update();
                draw();
            });
        }

        draw();
    </script>
</body>
</html>
