<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Exploration - Flashlight Fixed</title>
    <style>
        body { 
            margin: 0; 
            background: #000; 
            overflow: hidden; 
            color: white; 
            font-family: sans-serif; 
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 캔버스 2장을 겹칩니다 */
        canvas { position: absolute; top: 0; left: 0; }
        
        /* 빛을 처리하는 캔버스는 마우스 클릭을 방해하지 않게 설정 */
        #lightCanvas { pointer-events: none; }

        #ui-layer { 
            position: absolute; 
            top: 15px; left: 15px; 
            z-index: 10; /* UI는 제일 위에 */
            text-shadow: 1px 1px 2px black;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <canvas id="lightCanvas"></canvas>

        <div id="ui-layer">
            <h2>탐험 모드 (수정완료)</h2>
            <p>이동: W A S D | 손전등: 마우스</p>
        </div>
    </div>

    <script>
        const gameCanvas = document.getElementById("gameCanvas");
        const ctx = gameCanvas.getContext("2d");
        
        const lightCanvas = document.getElementById("lightCanvas");
        const lightCtx = lightCanvas.getContext("2d");

        // 화면 꽉 차게 설정
        function resize() {
            gameCanvas.width = lightCanvas.width = window.innerWidth;
            gameCanvas.height = lightCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // 플레이어와 조작 설정
        const player = { x: window.innerWidth / 2, y: window.innerHeight / 2, radius: 15, speed: 5 };
        const keys = {};
        const mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 - 100 };

        window.addEventListener("keydown", (e) => keys[e.code] = true);
        window.addEventListener("keyup", (e) => keys[e.code] = false);
        window.addEventListener("mousemove", (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        // 임시 맵 지형 (벽들)
        const walls = [
            { x: 200, y: 200, w: 150, h: 150 },
            { x: 700, y: 150, w: 50, h: 300 },
            { x: 300, y: 600, w: 400, h: 50 }
        ];

        function update() {
            if (keys["KeyW"]) player.y -= player.speed;
            if (keys["KeyS"]) player.y += player.speed;
            if (keys["KeyA"]) player.x -= player.speed;
            if (keys["KeyD"]) player.x += player.speed;
        }

        function draw() {
            // === 1. 메인 캔버스 그리기 (배경, 벽, 캐릭터) ===
            ctx.fillStyle = "#2b2b36"; // 차가운 느낌의 바닥색
            ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);

            // 벽 그리기
            ctx.fillStyle = "#111";
            walls.forEach(w => {
                ctx.fillRect(w.x, w.y, w.w, w.h);
                ctx.strokeStyle = "#444";
                ctx.strokeRect(w.x, w.y, w.w, w.h);
            });

            // 캐릭터 그리기
            ctx.fillStyle = "#00ffcc";
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();


            // === 2. 조명 캔버스 그리기 (어둠과 손전등) ===
            // 전체를 까맣게 덮기
            lightCtx.globalCompositeOperation = "source-over";
            lightCtx.fillStyle = "rgba(0, 0, 0, 0.95)"; // 0.95: 거의 안 보임
            lightCtx.fillRect(0, 0, lightCanvas.width, lightCanvas.height);

            // 빛을 비춘 부분만 투명하게 뚫어내기
            lightCtx.globalCompositeOperation = "destination-out";
            
            // 마우스 방향 각도 계산
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            
            // 부채꼴 손전등 그라데이션
            const gradient = lightCtx.createRadialGradient(player.x, player.y, 0, player.x, player.y, 500);
            gradient.addColorStop(0, "rgba(255, 255, 255, 1)");   // 중심은 완전 밝음 (투명하게 뚫림)
            gradient.addColorStop(0.8, "rgba(255, 255, 255, 0.5)"); // 중간
            gradient.addColorStop(1, "rgba(255, 255, 255, 0)");   // 끝은 흐려짐

            lightCtx.fillStyle = gradient;
            lightCtx.beginPath();
            lightCtx.moveTo(player.x, player.y);
            // 시야각(0.5) 만큼 부채꼴 그리기
            lightCtx.arc(player.x, player.y, 500, angle - 0.5, angle + 0.5); 
            lightCtx.lineTo(player.x, player.y);
            lightCtx.fill();
            
            // 캐릭터 발밑의 희미한 기본 시야
            lightCtx.beginPath();
            lightCtx.arc(player.x, player.y, 70, 0, Math.PI * 2);
            lightCtx.fillStyle = "rgba(255, 255, 255, 0.4)";
            lightCtx.fill();

            requestAnimationFrame(() => {
                update();
                draw();
            });
        }

        draw();
    </script>
</body>
</html>
