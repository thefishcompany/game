<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Midnight Phantasm - Director's Cut</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap');
        body { margin: 0; background: #000; overflow: hidden; color: white; font-family: 'Nanum Gothic', sans-serif; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { position: absolute; top: 0; left: 0; }
        #lightCanvas { pointer-events: none; } 

        #ui-layer { position: absolute; top: 15px; left: 15px; z-index: 10; text-shadow: 1px 1px 2px black; color: #aaa; font-size: 0.9rem; }
        #weapon-status { color: #ffeb3b; font-weight: bold; font-size: 1.2rem; margin-top: 10px; display: none; }
        #mission-status { color: #00ffcc; font-weight: bold; font-size: 1.2rem; margin-top: 5px; }
        
        #timer-box {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            color: #ffeb3b; font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 15px #ffeb3b;
            display: none; z-index: 15;
        }

        #warning-box {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            color: #ff4444; font-size: 4rem; font-weight: bold; text-shadow: 0 0 30px red;
            display: none; z-index: 15; animation: blink 0.3s infinite alternate; pointer-events: none;
        }
        @keyframes blink { from { opacity: 1; transform: translateX(-50%) scale(1); } to { opacity: 0.2; transform: translateX(-50%) scale(1.1); } }

        #dialogue-box { 
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); 
            width: 80%; max-width: 800px; height: 150px; background: rgba(0, 10, 20, 0.9); 
            border: 2px solid #aaa; border-radius: 5px; padding: 20px; box-sizing: border-box; 
            cursor: pointer; display: flex; flex-direction: column; z-index: 20; display: none;
        }
        #speaker-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; flex-shrink: 0; }
        #dialogue-text { font-size: 1.1rem; line-height: 1.6; word-break: keep-all; white-space: pre-wrap; overflow-y: auto; }
        
        #interaction-prompt {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1.2rem; font-weight: bold; color: #ffeb3b; text-shadow: 0 0 10px black; 
            display: none; z-index: 15; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <canvas id="lightCanvas"></canvas>

        <div id="ui-layer">
            <div>ë‚˜ì´íŠ¸ë©”ì–´ ìŠ¤ì¿¨ | ì‹¬ì—°ì˜ ë³µë„</div>
            <div id="controls-info" style="color: #00ffcc; margin-top: 10px;">[W,A,S,D] ì´ë™ | [ë§ˆìš°ìŠ¤] ì¡°ì¤€ | [ì¢Œí´ë¦­ ê¾¹ ëˆ„ë¥´ê¸°] ìë™ ì‚¬ê²© | [E] ì¡°ì‚¬</div>
            <div id="mission-status">ëª©í‘œ: 1í•™ë…„ 1ë°˜ êµì‹¤ì„ ìˆ˜ìƒ‰í•´ ë‹¨ì„œë¥¼ ì°¾ìœ¼ì„¸ìš”.</div>
            <div id="weapon-status">ë¬´ê¸°: ì—†ìŒ</div>
        </div>

        <div id="timer-box">60.00</div>
        <div id="warning-box">ë„ë§ì³!!! (ì™¼ìª½ ë ì¶œêµ¬ë¡œ)</div>
        <div id="interaction-prompt">[E] í‚¤ë¥¼ ëˆŒëŸ¬ ì¡°ì‚¬í•˜ê¸°</div>

        <div id="dialogue-box">
            <div id="speaker-name"></div>
            <div id="dialogue-text"></div>
        </div>
    </div>

    <script>
        const gameCanvas = document.getElementById("gameCanvas");
        const ctx = gameCanvas.getContext("2d");
        const lightCanvas = document.getElementById("lightCanvas");
        const lightCtx = lightCanvas.getContext("2d");

        function resize() {
            gameCanvas.width = lightCanvas.width = window.innerWidth;
            gameCanvas.height = lightCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let gameState = "STORY"; 
        
        // ì†ë„ ëŒ€í­ ìƒí–¥ (Fast-paced)
        const player = { x: 100, y: 450, radius: 15, speed: 7, hasWeapon: false };
        const camera = { x: 0, y: 0 }; 
        const keys = {};
        const mouse = { x: window.innerWidth/2, y: window.innerHeight/2 };
        const bullets = []; 
        const monsters = [];

        // ê¸°ê´€ì´ ì„¤ì • (ì—°ì‚¬ ì†ë„ ì•½ê°„ ìƒí–¥)
        let isMouseDown = false;
        let lastShotTime = 0;
        const fireRate = 100; // 0.1ì´ˆë§ˆë‹¤ í•œ ë°œ (ë” ì‹œì›í•˜ê²Œ)

        // ìƒì¡´ ëª¨ë“œ (1ë¶„ ë””íœìŠ¤) íƒ€ì´ë¨¸ ë³€ìˆ˜
        let isSurvivalActive = false;
        let survivalStartTime = 0;
        let lastSpawnTime = 0;

        let isChaseActive = false; 

        window.addEventListener("keydown", (e) => keys[e.code] = true);
        window.addEventListener("keyup", (e) => keys[e.code] = false);
        window.addEventListener("mousemove", (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
        window.addEventListener("mousedown", () => isMouseDown = true);
        window.addEventListener("mouseup", () => isMouseDown = false);

        const dialogueBox = document.getElementById("dialogue-box");
        const speakerEl = document.getElementById("speaker-name");
        const textEl = document.getElementById("dialogue-text");
        const promptEl = document.getElementById("interaction-prompt");
        const weaponStatus = document.getElementById("weapon-status");
        const missionStatus = document.getElementById("mission-status");
        const warningBox = document.getElementById("warning-box");
        const timerBox = document.getElementById("timer-box");

        // === ë¯¸ì¹œë“¯ì´ ë„“ì–´ì§„ ë§µ ë””ìì¸ (ê¸¸ì´ 8000px) ===
        let walls = [
            // ì™¸ê³½ í…Œë‘ë¦¬
            { id: "wall", x: -100, y: -200, w: 8500, h: 50 }, 
            { id: "wall", x: -100, y: 800,  w: 8500, h: 50 }, 
            { id: "wall", x: -50,  y: -200, w: 50, h: 1050 },  // ì„œìª½ ë (ì‹œì‘/íƒˆì¶œêµ¬)
            { id: "wall", x: 8400, y: -200, w: 50, h: 1050 },  // ë™ìª½ ë

            // ë³µë„ ê¸´ ë²½
            { id: "wall", x: 0, y: 350, w: 300, h: 50 },     
            { id: "wall", x: 450, y: 350, w: 550, h: 50 },   
            { id: "wall", x: 1150, y: 350, w: 2350, h: 50 }, 
            
            // ë³´ì•ˆ ê²Œì´íŠ¸ (ìƒì¡´ ëª¨ë“œ ì „ê¹Œì§€ ê¸¸ì„ ë§‰ëŠ” ë²½)
            { id: "security_gate", x: 3500, y: 400, w: 50, h: 400 }, 

            // ìƒì¡´ êµ¬ì—­ ì´í›„ì˜ ê¸´ ë³µë„ì™€ ë°©ë“¤
            { id: "wall", x: 3500, y: 350, w: 2500, h: 50 },
            { id: "wall", x: 6200, y: 350, w: 2000, h: 50 },

            // ì„¸ë¡œ ë²½ë“¤ (ë°© ë‚˜ëˆ„ê¸°)
            { id: "wall", x: 300, y: -200, w: 50, h: 550 },   
            { id: "wall", x: 1000, y: -200, w: 50, h: 550 },  
            { id: "wall", x: 1800, y: -200, w: 50, h: 550 },
            { id: "wall", x: 4500, y: -200, w: 50, h: 550 },
            { id: "wall", x: 6000, y: -200, w: 50, h: 550 },
            
            // ìµœì¢… êµì¥ì‹¤ ë²½ (x: 7500)
            { id: "wall", x: 7500, y: -200, w: 50, h: 500 },  
            { id: "wall", x: 7500, y: 450, w: 50, h: 350 },   

            // ë‚´ë¶€ ì¥ì• ë¬¼ (ê³³ê³³ì— ë„ë¦° ì±…ìƒë“¤ - ì¶”ê²©ì „ ë•Œ ë°©í•´ë¬¼ ì—­í• )
            { id: "desk", x: 450, y: -50, w: 150, h: 50 },  
            { id: "desk", x: 700, y: 150, w: 150, h: 50 },  
            { id: "desk", x: 1200, y: 50, w: 150, h: 50 },  
            { id: "desk", x: 2500, y: 500, w: 100, h: 200 },
            { id: "desk", x: 4000, y: 600, w: 200, h: 50 },
            { id: "desk", x: 5500, y: 400, w: 50, h: 200 },
            { id: "desk", x: 6800, y: 100, w: 300, h: 100 },
            { id: "desk", x: 8000, y: 200, w: 200, h: 100 } // êµì¥ì‹¤ ì±…ìƒ
        ];

        // ëŒ€ë³¸ ì¶”ê°€
        const introStory = [
            { speaker: "ë‚˜", color: "#fff", text: "(ì•¼ê°„ ììœ¨í•™ìŠµ ì¤‘ ì •ì „ì´ ì¼ì–´ë‚¬ë‹¤. í•™êµê°€ ëì—†ì´ ë„“ì–´ì§„ ê¸°ë¶„ì´ë‹¤.)" },
            { speaker: "ë‚˜", color: "#fff", text: "ìœ„ìª½ì˜ 1í•™ë…„ 1ë°˜ êµì‹¤ì— ë“¤ì–´ê°€ì„œ ëœí„´ì´ë‚˜ ì“¸ë§Œí•œ ê±¸ ì°¾ì•„ë³´ì." }
        ];

        const logStory = [
            { speaker: "ìˆœì°° ì¼ì§€", color: "#00ffcc", text: "ã€ì´ê³³ì˜ ë…€ì„ë“¤ì€ ëª¨í„° ì†Œë¦¬ë‚˜ ì´ì†Œë¦¬ë¥¼ ë“¤ìœ¼ë©´ ë¯¸ì¹œë“¯ì´ ëª°ë ¤ì˜¨ë‹¤.ã€" },
            { speaker: "ë‚˜", color: "#fff", text: "ì†Œë¦¬ì— ë°˜ì‘í•œë‹¤ë¼... ì˜†ì˜ 1í•™ë…„ 2ë°˜ êµì‹¤ì—ì„œ ë¬´ê¸°ë¥¼ ì°¾ì•„ë³´ì." }
        ];

        const weaponStory = [
            { speaker: "ì‹œìŠ¤í…œ", color: "#ffeb3b", text: "[ê°œì¡°ëœ ì „ë™ ë„¤ì¼ê±´] íšë“! (ì¢Œí´ë¦­ ì‹œ ì—°ì† ë°œì‚¬)" },
            { speaker: "ë‚˜", color: "#fff", text: "ì´ì œ ì‹¸ìš¸ ìˆ˜ ìˆê² ì–´. ë³µë„ë¥¼ ë”°ë¼ ê³„ì† ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ë³´ì." }
        ];

        const consoleStory = [
            { speaker: "ë³´ì•ˆ ì½˜ì†”", color: "#00ffcc", text: "ã€êµì¥ì‹¤ë¡œ ê°€ëŠ” ë³´ì•ˆ ê²Œì´íŠ¸ê°€ ì ê²¨ ìˆìŠµë‹ˆë‹¤. í•´í‚¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?ã€" },
            { speaker: "ë‚˜", color: "#fff", text: "í•´í‚¹ì„ ì‹œì‘í•˜ë©´ ì—„ì²­ë‚œ ê²½ê³ ìŒì´ ìš¸ë¦´í…ë°... ê´´ë¬¼ë“¤ì´ ëª°ë ¤ì˜¬ ê±°ì•¼." },
            { speaker: "ì‹œìŠ¤í…œ", color: "#ff4444", text: "[ê²½ê³ ] ë³´ì•ˆ í•´ì œê¹Œì§€ 60ì´ˆ ì†Œìš”. ìƒëª… ì‹ í˜¸ ë‹¤ìˆ˜ ì ‘ê·¼ ì¤‘!!" },
            { speaker: "ë‚˜", color: "#fff", text: "ì  ì¥, ì˜¨ë‹¤!! 1ë¶„ ë™ì•ˆ ì—¬ê¸°ì„œ ì‚´ì•„ë‚¨ì•„ì•¼ í•´!" }
        ];

        const keyStory = [
            { speaker: "ì‹œìŠ¤í…œ", color: "#ffeb3b", text: "[í˜„ê´€ ë§ˆìŠ¤í„° í‚¤] íšë“! 1ì¸µ ì¶œêµ¬ë¡œ ëŒì•„ê°€ íƒˆì¶œí•˜ì‹­ì‹œì˜¤." },
            { speaker: "ë‚˜", color: "#fff", text: "ë“œë””ì–´ ì°¾ì•˜ë‹¤. ì´ì œ ë§¨ ì²˜ìŒ ì‹œì‘í–ˆë˜ ì™¼ìª½ ëìœ¼ë¡œ ëŒì•„ê°€ë©´..." },
            { speaker: "???", color: "#ff4444", text: "KIIIIEEEEEEAAAKK!!!! (ì½°ì•™!!)" },
            { speaker: "ë‚˜", color: "#fff", text: "ë­, ë­ì•¼ ì´ ë¯¸ì¹œ í¬ê¸°ëŠ”?! ëŒì•„ê°€ëŠ” ê¸¸ì—ë„ ì”ì±™ì´ë“¤ì´ ê¹”ë ¸ì–ì•„!" },
            { speaker: "ë‚˜", color: "#fff", text: "ë’¤ëŒì•„ë³´ì§€ ë§ê³  ì™¼ìª½ ëê¹Œì§€ ë¬´ì¡°ê±´ ë‹¬ë ¤!!!" }
        ];

        let currentStory = []; let currentLine = 0; let isTyping = false; let textInterval;

        function startDialogue(storyData, onComplete = null) {
            gameState = "STORY"; currentStory = storyData; currentLine = 0;
            dialogueBox.style.display = "flex"; dialogueBox.onComplete = onComplete; showDialogue();
        }

        function typeWriter(text, i) {
            if (i < text.length) { textEl.innerHTML += text.charAt(i); textInterval = setTimeout(() => typeWriter(text, i + 1), 20); } 
            else { isTyping = false; }
        }

        function showDialogue() {
            if (currentLine >= currentStory.length) {
                dialogueBox.style.display = 'none'; gameState = "EXPLORE";
                if (dialogueBox.onComplete) { dialogueBox.onComplete(); dialogueBox.onComplete = null; }
                return;
            }
            isTyping = true; const line = currentStory[currentLine];
            speakerEl.innerText = line.speaker; speakerEl.style.color = line.color;
            textEl.innerHTML = ""; typeWriter(line.text, 0);
        }

        dialogueBox.addEventListener("click", () => {
            if (isTyping) { clearTimeout(textInterval); textEl.innerHTML = currentStory[currentLine].text; isTyping = false; } 
            else { currentLine++; showDialogue(); }
        });

        const interactables = [
            { id: "log", x: 800, y: -50, radius: 15, color: "#00ffcc", active: true, story: logStory }, 
            { id: "weapon", x: 1600, y: 100, radius: 15, color: "#ffeb3b", active: true, story: weaponStory }, 
            { id: "console", x: 3400, y: 600, radius: 20, color: "#ff8800", active: true, story: consoleStory }, // 1ë¶„ ìƒì¡´ íŠ¸ë¦¬ê±°
            { id: "master_key", x: 8100, y: 250, radius: 15, color: "#ff4444", active: true, story: keyStory } 
        ];

        function checkCollision(obj, nx, ny) {
            for (let w of walls) {
                if (nx + obj.radius > w.x && nx - obj.radius < w.x + w.w && ny + obj.radius > w.y && ny - obj.radius < w.y + w.h) { return true; }
            }
            return false;
        }

        function update() {
            if (gameState === "EXPLORE") {
                // 1. í”Œë ˆì´ì–´ ì´ë™ (ì†ë„ ìƒí–¥ë¨)
                let nextX = player.x; let nextY = player.y;
                if (keys["KeyW"]) nextY -= player.speed;
                if (keys["KeyS"]) nextY += player.speed;
                if (keys["KeyA"]) nextX -= player.speed;
                if (keys["KeyD"]) nextX += player.speed;
                if (!checkCollision(player, nextX, player.y)) player.x = nextX;
                if (!checkCollision(player, player.x, nextY)) player.y = nextY;

                camera.x = player.x - window.innerWidth / 2;
                camera.y = player.y - window.innerHeight / 2;

                // 2. ê¸°ê´€ì´ ë°œì‚¬ (ì´ì•Œ ì†ë„ 30ìœ¼ë¡œ ì´ˆê³ ì†)
                if (player.hasWeapon && isMouseDown) {
                    const now = Date.now();
                    if (now - lastShotTime > fireRate) {
                        const worldMouseX = mouse.x + camera.x; const worldMouseY = mouse.y + camera.y;
                        const spread = (Math.random() - 0.5) * 0.2; 
                        const angle = Math.atan2(worldMouseY - player.y, worldMouseX - player.x) + spread;
                        bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle) * 30, vy: Math.sin(angle) * 30, radius: 3 });
                        lastShotTime = now;
                    }
                }

                // 3. ì´ì•Œ ì´ë™
                for (let i = bullets.length - 1; i >= 0; i--) {
                    let b = bullets[i];
                    b.x += b.vx; b.y += b.vy;
                    let hitWall = false;
                    for (let w of walls) {
                        if (b.x > w.x && b.x < w.x + w.w && b.y > w.y && b.y < w.y + w.h) { hitWall = true; break; }
                    }
                    if (hitWall || Math.hypot(b.x - player.x, b.y - player.y) > 1200) { bullets.splice(i, 1); }
                }

                // === 4. 1ë¶„ ìƒì¡´(ë””íœìŠ¤) ëª¨ë“œ ë¡œì§ ===
                if (isSurvivalActive) {
                    let elapsed = (Date.now() - survivalStartTime) / 1000;
                    let timeLeft = 60 - elapsed;
                    
                    if (timeLeft <= 0) {
                        // 1ë¶„ ìƒì¡´ ì™„ë£Œ!
                        isSurvivalActive = false;
                        timerBox.style.display = "none";
                        missionStatus.innerText = "ëª©í‘œ: ê²Œì´íŠ¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤! ë³µë„ ë êµì¥ì‹¤ë¡œ ì§„ì…í•˜ì„¸ìš”.";
                        missionStatus.style.color = "#00ffcc";
                        
                        // ì•ì„ ê°€ë¡œë§‰ë˜ ë³´ì•ˆ ê²Œì´íŠ¸ ì‚­ì œ
                        walls = walls.filter(w => w.id !== "security_gate");
                        
                        // í™”ë©´ í”ë“¤ë¦¼ + ì•Œë¦¼
                        alert("ë³´ì•ˆ ì‹œìŠ¤í…œ í•´ì œ ì™„ë£Œ! ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!");
                    } else {
                        timerBox.innerText = timeLeft.toFixed(2);
                        // 5ì´ˆë§ˆë‹¤ ëª¬ìŠ¤í„° 1ë§ˆë¦¬ ìŠ¤í° (ìœ„, ì•„ë˜, ì˜¤ë¥¸ìª½ ëœë¤ ìœ„ì¹˜ì—ì„œ)
                        if (Date.now() - lastSpawnTime > 5000) {
                            let spawnDist = 600;
                            let angle = Math.random() * Math.PI * 2;
                            monsters.push({ 
                                x: player.x + Math.cos(angle) * spawnDist, 
                                y: player.y + Math.sin(angle) * spawnDist, 
                                radius: 20, speed: 4.5, hp: 6, isInvincible: false, color: "#800080" 
                            });
                            lastSpawnTime = Date.now();
                        }
                    }
                }

                // 5. ëª¬ìŠ¤í„° AI (ê¸°ë³¸ ì†ë„ ìƒí–¥ë¨)
                for (let i = monsters.length - 1; i >= 0; i--) {
                    let m = monsters[i];
                    const angle = Math.atan2(player.y - m.y, player.x - m.x);
                    let mNextX = m.x + Math.cos(angle) * m.speed;
                    let mNextY = m.y + Math.sin(angle) * m.speed;
                    
                    // ë³´ìŠ¤ ëª¬ìŠ¤í„°ëŠ” ì±…ìƒ ê°™ì€ ì‘ì€ ì¥ì• ë¬¼ ë¬´ì‹œí•˜ê³  ë²½ë§Œ ì¶©ëŒ
                    if (!checkCollision(m, mNextX, m.y)) m.x = mNextX;
                    if (!checkCollision(m, m.x, mNextY)) m.y = mNextY;

                    for (let j = bullets.length - 1; j >= 0; j--) {
                        let b = bullets[j];
                        if (Math.hypot(b.x - m.x, b.y - m.y) < m.radius + b.radius) {
                            bullets.splice(j, 1);
                            if (!m.isInvincible) { 
                                m.hp--; 
                                if (m.hp <= 0) { monsters.splice(i, 1); break; } // ì£½ìœ¼ë©´ ë°°ì—´ì—ì„œ ì œê±°í•˜ê³  ë£¨í”„ íƒˆì¶œ
                            }
                        }
                    }

                    if (monsters[i] && Math.hypot(player.x - m.x, player.y - m.y) < player.radius + m.radius) {
                        player.x -= Math.cos(angle) * 15; // ë§ìœ¼ë©´ í¬ê²Œ ë°€ë ¤ë‚¨
                    }
                }

                // 6. ìƒí˜¸ì‘ìš©
                let canInteract = false;
                interactables.forEach(item => {
                    if (item.active && Math.hypot(player.x - item.x, player.y - item.y) < 80) { 
                        canInteract = true;
                        if (keys["KeyE"]) {
                            item.active = false; keys["KeyE"] = false; 
                            
                            if (item.id === "log") {
                                missionStatus.innerText = "ëª©í‘œ: 1í•™ë…„ 2ë°˜ êµì‹¤ì—ì„œ ë¬´ê¸°ë¥¼ ì°¾ìœ¼ì„¸ìš”."; startDialogue(item.story);
                            }
                            else if (item.id === "weapon") {
                                player.hasWeapon = true; weaponStatus.style.display = "block";
                                weaponStatus.innerText = "ë¬´ê¸°: ê°œì¡°ëœ ì „ë™ ë„¤ì¼ê±´ (ì—°ì‚¬)";
                                missionStatus.innerText = "ëª©í‘œ: ë³µë„ ì¤‘ì•™ì˜ ë³´ì•ˆ ì½˜ì†”ì„ ì°¾ì•„ í•´í‚¹í•˜ì„¸ìš”.";
                                startDialogue(item.story);
                            } 
                            else if (item.id === "console") {
                                startDialogue(item.story, () => {
                                    // 1ë¶„ ìƒì¡´ ëª¨ë“œ ì‹œì‘
                                    isSurvivalActive = true;
                                    survivalStartTime = Date.now();
                                    lastSpawnTime = Date.now();
                                    timerBox.style.display = "block";
                                    missionStatus.innerText = "ëª©í‘œ: ë¬¸ì´ ì—´ë¦´ ë•Œê¹Œì§€ ì‚´ì•„ë‚¨ìœ¼ì„¸ìš”!!!";
                                    missionStatus.style.color = "#ff4444";
                                });
                            }
                            else if (item.id === "master_key") {
                                missionStatus.innerText = "ëª©í‘œ: ë¹¨ë¦¬ ì‹œì‘ ì§€ì (ì™¼ìª½ ë ì¶œêµ¬)ìœ¼ë¡œ ë„ë§ì¹˜ì„¸ìš”!!";
                                missionStatus.style.color = "#ff4444";
                                startDialogue(item.story, () => {
                                    isChaseActive = true; warningBox.style.display = "block";
                                    // ëŒ€ë§ì˜ ê±°ëŒ€ ë³´ìŠ¤ ìŠ¤í° (ì†ë„ 6.2ë¡œ í”Œë ˆì´ì–´ ì†ë„ 7ì„ ë¯¸ì¹œë“¯ì´ ì«“ì•„ê°)
                                    monsters.push({ x: 8300, y: 250, radius: 55, speed: 6.2, hp: 9999, isInvincible: true, color: "#ff0000" });
                                    
                                    // ëŒì•„ê°€ëŠ” ê¸¸ì„ ë°©í•´í•  ì”ì±™ì´ ëª¬ìŠ¤í„°ë“¤ ë§µ ê³³ê³³ì— ë°°ì¹˜
                                    for(let k=1000; k<7000; k+=600) {
                                        monsters.push({ x: k, y: 500, radius: 20, speed: 4, hp: 5, isInvincible: false, color: "#800080" });
                                    }
                                });
                            }
                        }
                    }
                });
                promptEl.style.display = canInteract ? "block" : "none";
                
                if (isChaseActive && player.x < 50) {
                    gameState = "WIN"; alert("ğŸ”¥ 10ë¶„ì˜ ì‚¬íˆ¬ ëì— íƒˆì¶œ ì„±ê³µ!! ë‹¹ì‹ ì€ ì „ì„¤ì…ë‹ˆë‹¤! ğŸ”¥"); location.reload();
                }
            }
        }

        function draw() {
            ctx.fillStyle = "#0a0a0c"; ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
            ctx.save(); ctx.translate(-camera.x, -camera.y);

            // ë§µì„ 8000px ì´ìƒ ê·¸ë¦¬ê¸°
            ctx.fillStyle = "#111"; ctx.fillRect(-500, -500, 9500, 2000);
            ctx.strokeStyle = "#1a1a1c";
            for(let i=-500; i<9000; i+=100) { ctx.beginPath(); ctx.moveTo(i,-500); ctx.lineTo(i,1500); ctx.stroke(); }
            for(let i=-500; i<1500; i+=100) { ctx.beginPath(); ctx.moveTo(-500,i); ctx.lineTo(9000,i); ctx.stroke(); }

            ctx.fillStyle = "#222";
            walls.forEach(w => { 
                ctx.fillStyle = w.id === "security_gate" ? "#00ffcc" : "#222"; // ì ê¸´ ë¬¸ì€ ì²­ë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                ctx.fillRect(w.x, w.y, w.w, w.h); 
                ctx.strokeStyle = "#444"; ctx.strokeRect(w.x, w.y, w.w, w.h); 
            });

            interactables.forEach(item => {
                if (item.active) {
                    ctx.shadowBlur = 20; ctx.shadowColor = item.color; ctx.fillStyle = item.color;
                    ctx.beginPath(); ctx.arc(item.x, item.y, item.radius, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0; 
                }
            });

            monsters.forEach(m => { ctx.fillStyle = m.color; ctx.beginPath(); ctx.arc(m.x, m.y, m.radius, 0, Math.PI * 2); ctx.fill(); });
            ctx.fillStyle = "#ffeb3b"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.fill(); });
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2); ctx.fill();
            ctx.restore(); 

            // === ì¡°ëª… ìº”ë²„ìŠ¤ ===
            lightCtx.globalCompositeOperation = "source-over";
            let darkness = gameState === "STORY" ? "rgba(0,0,0,1)" : "rgba(0, 0, 5, 0.96)";
            if (isChaseActive && Math.random() > 0.8) darkness = "rgba(40, 0, 0, 0.95)"; 
            if (isSurvivalActive && Math.random() > 0.9) darkness = "rgba(0, 40, 40, 0.95)"; // ìƒì¡´ ë• ì²­ë¡ìƒ‰ ê¹œë¹¡ì„

            lightCtx.fillStyle = darkness; lightCtx.fillRect(0, 0, lightCanvas.width, lightCanvas.height);

            if (gameState === "EXPLORE") {
                lightCtx.globalCompositeOperation = "destination-out";
                const screenPlayerX = window.innerWidth / 2; const screenPlayerY = window.innerHeight / 2;
                const worldMouseX = mouse.x + camera.x; const worldMouseY = mouse.y + camera.y;
                const angle = Math.atan2(worldMouseY - player.y, worldMouseX - player.x);
                
                const gradient = lightCtx.createRadialGradient(screenPlayerX, screenPlayerY, 0, screenPlayerX, screenPlayerY, 900);
                gradient.addColorStop(0, "rgba(255, 255, 255, 1)");   
                gradient.addColorStop(0.5, "rgba(255, 255, 255, 0.8)"); 
                gradient.addColorStop(1, "rgba(255, 255, 255, 0)");   

                lightCtx.fillStyle = gradient; lightCtx.beginPath(); lightCtx.moveTo(screenPlayerX, screenPlayerY);
                const beamWidth = isChaseActive ? 0.7 + Math.random()*0.1 : 1.0; // ì‹œì•¼ë¥¼ ë” ë„“ê²Œ
                lightCtx.arc(screenPlayerX, screenPlayerY, 900, angle - beamWidth, angle + beamWidth); 
                lightCtx.lineTo(screenPlayerX, screenPlayerY); lightCtx.fill();
                
                lightCtx.beginPath(); lightCtx.arc(screenPlayerX, screenPlayerY, 150, 0, Math.PI * 2);
                lightCtx.fillStyle = "rgba(255, 255, 255, 0.7)"; lightCtx.fill();

                bullets.forEach(b => {
                    lightCtx.beginPath(); lightCtx.arc(b.x - camera.x, b.y - camera.y, 60, 0, Math.PI * 2);
                    lightCtx.fillStyle = "rgba(255, 255, 255, 0.9)"; lightCtx.fill();
                });

                monsters.forEach(m => {
                    lightCtx.beginPath(); lightCtx.arc(m.x - camera.x, m.y - camera.y, m.radius, 0, Math.PI * 2);
                    lightCtx.fillStyle = m.isInvincible ? "rgba(255, 0, 0, 0.7)" : "rgba(255, 0, 0, 0.4)"; lightCtx.fill();
                });
            }

            // === ì™€ì´ë“œ ë¯¸ë‹ˆë§µ ì—…ë°ì´íŠ¸ ===
            if (gameState === "EXPLORE") {
                lightCtx.globalCompositeOperation = "source-over";
                
                const mmW = 350; const mmH = 80; // ê¸¸ì–´ì§„ ë§µì— ë§ì¶° ë¯¸ë‹ˆë§µ ê°€ë¡œë¥¼ ë„“í˜
                const mmX = window.innerWidth - mmW - 20; 
                const mmY = 20;

                lightCtx.fillStyle = "rgba(0, 0, 0, 0.8)"; lightCtx.fillRect(mmX, mmY, mmW, mmH);
                lightCtx.strokeStyle = "#444"; lightCtx.lineWidth = 2; lightCtx.strokeRect(mmX, mmY, mmW, mmH);

                const mapStartX = -100; const mapStartY = -200;
                const mapWidth = 8600; const mapHeight = 1200; // ë„“ì–´ì§„ ë§µ ê¸°ì¤€ ë°˜ì˜
                const scaleX = mmW / mapWidth; const scaleY = mmH / mapHeight;

                lightCtx.fillStyle = "#666";
                walls.forEach(w => {
                    lightCtx.fillStyle = w.id === "security_gate" ? "#00ffcc" : "#666";
                    lightCtx.fillRect(mmX + (w.x - mapStartX) * scaleX, mmY + (w.y - mapStartY) * scaleY, w.w * scaleX, w.h * scaleY);
                });

                interactables.forEach(item => {
                    if(item.active) {
                        lightCtx.fillStyle = item.color; lightCtx.beginPath();
                        lightCtx.arc(mmX + (item.x - mapStartX) * scaleX, mmY + (item.y - mapStartY) * scaleY, 3, 0, Math.PI*2); lightCtx.fill();
                    }
                });

                lightCtx.fillStyle = "#ff4444";
                monsters.forEach(m => {
                    lightCtx.beginPath(); lightCtx.arc(mmX + (m.x - mapStartX) * scaleX, mmY + (m.y - mapStartY) * scaleY, m.isInvincible ? 5 : 3, 0, Math.PI*2); lightCtx.fill();
                });

                lightCtx.fillStyle = "#00ffcc"; lightCtx.beginPath();
                lightCtx.arc(mmX + (player.x - mapStartX) * scaleX, mmY + (player.y - mapStartY) * scaleY, 4, 0, Math.PI*2); lightCtx.fill();
            }

            requestAnimationFrame(() => { update(); draw(); });
        }

        startDialogue(introStory); draw();
    </script>
</body>
</html>
